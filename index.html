<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Coverage Check</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f8fafc;
      padding: 16px;
    }

    .wrap {
      background: #fff;
      border: 1.5px solid #e2e8f0;
      border-radius: 12px;
      padding: 18px 20px;
    }

    h3 {
      font-size: 0.95rem;
      font-weight: 700;
      color: #1e293b;
      margin-bottom: 3px;
    }

    .sub {
      font-size: 0.78rem;
      color: #64748b;
      margin-bottom: 14px;
      line-height: 1.4;
    }

    .row {
      display: flex;
      gap: 8px;
    }

    input {
      flex: 1;
      padding: 10px 13px;
      border: 1.5px solid #cbd5e1;
      border-radius: 8px;
      font-size: 0.9rem;
      color: #0f172a;
      outline: none;
      background: #fff;
      transition: border-color 0.2s;
    }

    input:focus {
      border-color: #1a3a5c;
      box-shadow: 0 0 0 3px rgba(26,58,92,0.08);
    }

    button {
      background: #1a3a5c;
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 10px 18px;
      font-size: 0.88rem;
      font-weight: 600;
      cursor: pointer;
      white-space: nowrap;
      display: flex;
      align-items: center;
      gap: 7px;
      transition: background 0.2s;
    }

    button:hover { background: #14304d; }
    button:disabled { background: #94a3b8; cursor: not-allowed; }

    .spin {
      width: 13px; height: 13px;
      border: 2px solid rgba(255,255,255,0.3);
      border-top-color: #fff;
      border-radius: 50%;
      animation: sp 0.7s linear infinite;
      display: none;
    }
    @keyframes sp { to { transform: rotate(360deg); } }

    .hint {
      font-size: 0.72rem;
      color: #94a3b8;
      margin-top: 5px;
    }

    .result {
      display: none;
      margin-top: 12px;
      border-radius: 8px;
      padding: 12px 14px;
      align-items: flex-start;
      gap: 10px;
      font-size: 0.83rem;
      line-height: 1.5;
    }
    .result.show { display: flex; }
    .result.yes { background: #f0fdf4; border: 1.5px solid #86efac; }
    .result.no  { background: #fff7ed; border: 1.5px solid #fcd34d; }
    .result.err { background: #fef2f2; border: 1.5px solid #fca5a5; }

    .r-icon { font-size: 1.25rem; flex-shrink: 0; margin-top: 1px; }

    .r-body strong {
      display: block;
      font-weight: 700;
      font-size: 0.85rem;
      margin-bottom: 2px;
    }
    .result.yes .r-body strong { color: #15803d; }
    .result.no  .r-body strong { color: #b45309; }
    .result.err .r-body strong { color: #b91c1c; }

    .r-addr {
      margin-top: 4px;
      font-size: 0.72rem;
      color: #64748b;
      font-style: italic;
    }
  </style>
</head>
<body>
<div class="wrap">
  <h3>Step 1 â€” Check Your Coverage</h3>
  <p class="sub">Confirm your address is within our service area before completing the form below.</p>

  <div class="row">
    <input type="text" id="addr" placeholder="e.g. 123 Main St, London, ON" autocomplete="off"/>
    <button id="btn" onclick="doCheck()">
      <span class="spin" id="spin"></span>
      <span id="btn-text">Check</span>
    </button>
  </div>
  <p class="hint">Include city name â€” e.g. "Strathroy, ON" or "Woodstock, ON"</p>

  <div class="result" id="result">
    <div class="r-icon" id="r-icon"></div>
    <div class="r-body">
      <strong id="r-title"></strong>
      <span id="r-msg"></span>
      <div class="r-addr" id="r-addr"></div>
    </div>
  </div>
</div>

<script>
  // â”€â”€ Boundary polygon [lng, lat] â€” traced from L.U. 120 London map â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  var POLY = [
    [-82.50,42.05],[-82.40,42.08],[-82.30,42.10],[-82.20,42.12],
    [-82.15,42.15],[-82.10,42.17],[-82.05,42.20],[-81.95,42.20],
    [-81.85,42.22],[-81.78,42.20],[-81.72,42.22],[-81.65,42.25],
    [-81.60,42.27],[-81.52,42.28],[-81.45,42.30],[-81.38,42.32],
    [-81.35,42.35],[-81.30,42.38],[-81.22,42.40],[-81.15,42.42],
    [-81.08,42.45],[-81.02,42.48],[-80.95,42.58],[-80.88,42.65],
    [-80.85,42.70],[-80.85,42.80],[-80.88,42.85],[-80.88,42.90],
    [-80.82,42.95],[-80.78,43.00],[-80.72,43.02],[-80.68,43.05],
    [-80.62,43.08],[-80.60,43.12],[-80.58,43.18],[-80.60,43.25],
    [-80.62,43.32],[-80.65,43.38],[-80.65,43.42],[-80.68,43.48],
    [-80.72,43.52],[-80.75,43.58],[-80.80,43.65],[-80.82,43.72],
    [-80.85,43.78],[-80.88,43.85],[-80.90,43.90],[-80.88,43.95],
    [-80.85,44.00],[-80.80,44.05],[-80.78,44.10],[-80.72,44.12],
    [-80.68,44.15],[-80.62,44.18],[-80.58,44.22],[-81.00,44.30],
    [-81.10,44.28],[-81.20,44.25],[-81.28,44.22],[-81.35,44.18],
    [-81.45,44.15],[-81.55,44.12],[-81.62,44.10],[-81.70,44.05],
    [-81.78,44.02],[-81.85,44.00],[-81.90,43.98],[-82.00,43.95],
    [-82.05,43.90],[-82.08,43.85],[-82.10,43.80],[-82.12,43.72],
    [-82.15,43.65],[-82.18,43.58],[-82.22,43.50],[-82.25,43.42],
    [-82.28,43.35],[-82.30,43.25],[-82.32,43.15],[-82.35,43.08],
    [-82.38,43.00],[-82.40,42.92],[-82.45,42.85],[-82.48,42.75],
    [-82.50,42.65],[-82.52,42.55],[-82.50,42.45],[-82.50,42.35],
    [-82.50,42.25],[-82.50,42.05]
  ];

  function pip(pt, poly) {
    var x=pt[0], y=pt[1], inside=false;
    for (var i=0, j=poly.length-1; i<poly.length; j=i++) {
      var xi=poly[i][0], yi=poly[i][1], xj=poly[j][0], yj=poly[j][1];
      if ((yi>y)!==(yj>y) && x<(xj-xi)*(y-yi)/(yj-yi)+xi) inside=!inside;
    }
    return inside;
  }

  // â”€â”€ Notify JotForm parent frame â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function notify(confirmed) {
    window.parent.postMessage(
      { type: 'lu120_coverage', confirmed: confirmed },
      '*'   // JotForm's domain â€” '*' works across all JotForm URLs
    );
  }

  function setLoading(on) {
    document.getElementById('btn').disabled = on;
    document.getElementById('spin').style.display = on ? 'block' : 'none';
    document.getElementById('btn-text').textContent = on ? 'Checkingâ€¦' : 'Check';
  }

  function showResult(type, icon, title, msg, addr) {
    var el = document.getElementById('result');
    el.className = 'result show ' + type;
    document.getElementById('r-icon').textContent = icon;
    document.getElementById('r-title').textContent = title;
    document.getElementById('r-msg').textContent = msg;
    document.getElementById('r-addr').textContent = addr ? 'Matched: ' + addr : '';
  }

  window.doCheck = function() {
    var raw = document.getElementById('addr').value.trim();
    if (!raw) {
      showResult('err','âš ï¸','Please enter an address','Type your service address above.','');
      notify(false);
      return;
    }
    var q = raw;
    if (!/ontario|,\s*on\b|canada/i.test(q)) q += ', Ontario, Canada';

    setLoading(true);
    notify(false); // reset submit button while checking

    fetch('https://nominatim.openstreetmap.org/search?format=json&limit=1&q='
      + encodeURIComponent(q) + '&countrycodes=ca',
      { headers: { 'Accept-Language':'en', 'User-Agent':'LU120/1.0' } })
    .then(function(r){ return r.json(); })
    .then(function(data) {
      if (!data || !data.length) {
        showResult('err','â“','Address not found',
          "Couldn't find that address. Try adding city or postal code.",'');
        notify(false);
        return;
      }
      var lat = parseFloat(data[0].lat);
      var lng = parseFloat(data[0].lon);
      var inside = pip([lng,lat], POLY);
      if (inside) {
        showResult('yes','âœ…',"You're in our coverage area!",
          'Your address is within the L.U. 120 London service area.',
          data[0].display_name);
        notify(true);
      } else {
        showResult('no','âš ï¸','Outside our coverage area',
          'This address is not within our service area. Please contact us to discuss options.',
          data[0].display_name);
        notify(false);
      }
    })
    .catch(function(){
      showResult('err','ðŸ”Œ','Connection error',
        'Address lookup failed. Check your internet connection and try again.','');
      notify(false);
    })
    .finally(function(){ setLoading(false); });
  };

  document.getElementById('addr').addEventListener('keydown', function(e){
    if (e.key==='Enter') { e.preventDefault(); doCheck(); }
  });

  // On load, tell JotForm to hide submit immediately
  window.addEventListener('load', function(){ notify(false); });
</script>
</body>
</html>
